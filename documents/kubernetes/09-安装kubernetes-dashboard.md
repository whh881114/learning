# 安装kubernetes-dashboard

## 前言
- https://github.com/kubernetes/dashboard/releases/download/kubernetes-dashboard-7.5.0/kubernetes-dashboard-7.5.0.tgz

## 部署
- 使用helm安装kubernetes-dashboard。

- kong需要声明image和tag。
  ```yaml
  kong:
    enabled: true
    replicaCount: 3
    image:
      repository: kong/kong
      tag: 3.6.x # 或指定具体的版本号
    ## Configuration reference: https://docs.konghq.com/gateway/3.6.x/reference/configuration
    env:
      dns_order: LAST,A,CNAME,AAAA,SRV
      plugins: 'off'
      nginx_worker_processes: 1
    ingressController:
      enabled: false
    dblessConfig:
      configMap: kong-dbless-config
    proxy:
      type: NodePort
      http:
        enabled: true
  ```

- **因为环境中暂时没有https证书，所以启用了http，但是，这里出现问题了，必须要用https协议，否则会出现401
  错误。所以，这里kong.proxy.type指定为NodePort，可以复现登录错误。**
  ```shell
  2024-08-08 11:07:31.822 E0808 03:07:31.822540       1 handler.go:33] "Could not get user" err="MSG_LOGIN_UNAUTHORIZED_ERROR"
  2024-08-08 11:06:38.607 I0808 03:06:38.607705       1 main.go:41] "Listening and serving insecurely on" address="0.0.0.0:8000"
  2024-08-08 11:06:38.607 I0808 03:06:38.607522       1 init.go:47] Using in-cluster config
  2024-08-08 11:06:38.607 I0808 03:06:38.607466       1 main.go:34] "Starting Kubernetes Dashboard Auth" version="1.1.3"
  ```

- cert-manager自动管理证书失败，现在采用另一种访求更新证书，所以现在启用https，所以app.ingress配置如下。
```yaml
    enabled: true
    hosts:
      # Keep 'localhost' host only if you want to access Dashboard using 'kubectl port-forward ...' on:
      # https://localhost:8443
      - "kubernetes-dashboard.idc-ingress-nginx.roywong.top"
      - "k8s-dash.idc-ingress-nginx.roywong.top"
    ingressClassName: "nginx"
    # Use only if your ingress controllers support default ingress classes.
    # If set to true ingressClassName will be ignored and not added to the Ingress resources.
    # It should fall back to using IngressClass marked as the default.
    useDefaultIngressClass: false
    # This will append our Ingress with annotations required by our default configuration.
    #    nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
    #    nginx.ingress.kubernetes.io/ssl-passthrough: "true"
    #    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    useDefaultAnnotations: true
    pathType: ImplementationSpecific
    # If path is not the default (/), rewrite-target annotation will be added to the Ingress.
    # It allows serving Kubernetes Dashboard on a sub-path. Make sure that the configured path
    # does not conflict with gateway route configuration.
    path: /
    issuer:
      name: disabled
      # Scope determines what kind of issuer annotation will be used on ingress resource
      # - default - adds 'cert-manager.io/issuer'
      # - cluster - adds 'cert-manager.io/cluster-issuer'
      # - disabled - disables cert-manager annotations
      scope: cluster
    tls:
      enabled: true
      # If provided it will override autogenerated secret name
      secretName: "tls-wildcard-idc-ingress-nginx-roywong-top"
    labels: {}
    annotations: {}
  # Use the following toleration if Dashboard can be deployed on a tainted control-plane nodes
  # - key: node-role.kubernetes.io/control-plane
  #   effect: NoSchedule
  tolerations: []
  affinity: {}
```


## 安装结果
```shell
ok: [10.255.1.12] => {
    "msg": [
        [
            "release \"kubernetes-dashboard\" uninstalled",
            "NAME: kubernetes-dashboard",
            "LAST DEPLOYED: Thu Aug  8 11:30:25 2024",
            "NAMESPACE: kubernetes-dashboard",
            "STATUS: deployed",
            "REVISION: 1",
            "TEST SUITE: None",
            "NOTES:",
            "*************************************************************************************************",
            "*** PLEASE BE PATIENT: Kubernetes Dashboard may need a few minutes to get up and become ready ***",
            "*************************************************************************************************",
            "",
            "Congratulations! You have just installed Kubernetes Dashboard in your cluster.",
            "",
            "To access Dashboard run:",
            "  kubectl -n kubernetes-dashboard port-forward svc/kubernetes-dashboard-kong-proxy 8443:443",
            "",
            "NOTE: In case port-forward command does not work, make sure that kong service name is correct.",
            "      Check the services in Kubernetes Dashboard namespace using:",
            "        kubectl -n kubernetes-dashboard get svc",
            "",
            "Dashboard will be available at:",
            "  https://localhost:8443",
            "",
            "",
            "",
            "Looks like you are deploying Kubernetes Dashboard on a custom domain(s).",
            "Please make sure that the ingress configuration is valid.",
            "Dashboard should be accessible on your configured domain(s) soon:",
            "  - https://kubernetes-dashboard.ingress-nginx.freedom.org",
            "  - https://k8s-dash.ingress-nginx.freedom.org"
        ],
        []
    ]
}
```